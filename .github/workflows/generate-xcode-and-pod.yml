name: Generate Xcode project and run CocoaPods

on:
  workflow_dispatch:

jobs:
  generate_and_pod:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install Ruby gems
        run: |
          gem install xcodeproj --no-document
          gem install cocoapods --no-document
          pod --version

      - name: Create minimal Xcode project (Test.xcodeproj)
        run: |
          cat > make_project.rb <<'RUBY'
require 'xcodeproj'
project_path = 'Test.xcodeproj'
project = Xcodeproj::Project.new(project_path)
target = project.new_target(:application, 'Test', :ios, '13.0')
plist_path = 'Info.plist'
unless File.exist?(plist_path)
  File.write(plist_path, <<~PLIST)
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>CFBundleIdentifier</key>
  <string>com.example.Test</string>
  <key>CFBundleName</key>
  <string>Test</string>
</dict>
</plist>
PLIST
end
resources = target.resources_build_phase
resources.add_file_reference(project.new_file(plist_path))
project.save
puts "Created #{project_path}"
RUBY
          ruby make_project.rb
          ls -la Test.xcodeproj || true

      - name: Ensure Podfile exists & show it
        run: |
          if [ ! -f Podfile ]; then
            echo "ERROR: Podfile not found in repository root." >&2
            exit 1
          fi
          echo "Podfile found:"
          sed -n '1,200p' Podfile || true

      - name: Run pod install
        run: |
          pod install --repo-update
          ls -la

      - name: Create PR with generated files
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: chore: add generated Test.xcodeproj and Podfile.lock (CI)
          branch: ci/add-generated-xcodeproj
          title: chore: add generated Test.xcodeproj and Podfile.lock (CI)
          body: This PR was created automatically by workflow to add a minimal Xcode project and Podfile.lock generated in CI.
          labels: automated
